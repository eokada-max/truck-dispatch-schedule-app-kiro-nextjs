# Bug Fix: リアルタイム同期のスキーマ不整合エラー

**日付**: 2024-11-02  
**重要度**: Critical  
**影響範囲**: リアルタイム同期機能全体

## 問題の概要

リソースカレンダー（`/schedules/resource`）でリアルタイム更新が発生すると、以下のエラーが発生していました：

```
TypeError: Cannot read properties of undefined (reading 'split')
at SchedulesClient.useEffect.scheduleDates (app\schedules\SchedulesClient.tsx:73:44)
```

### 症状
- Aタブで操作した内容がBタブに反映されない
- スケジュールカードが非表示になる
- コンソールにTypeErrorが表示される

## 根本原因

データベーススキーマが旧形式から新形式に移行されたが、リアルタイム同期の`convertDbToSchedule`関数が更新されていなかった。

### 旧スキーマ（使用されていた変換ロジック）
```typescript
{
  event_date: string,
  start_time: string,
  end_time: string,
  title: string,
  destination_address: string,
  content: string,
  // ...
}
```

### 新スキーマ（実際のデータベース構造）
```typescript
{
  loading_datetime: string,
  delivery_datetime: string,
  loading_location_id: string,
  loading_location_name: string,
  loading_address: string,
  delivery_location_id: string,
  delivery_location_name: string,
  delivery_address: string,
  cargo: string,
  billing_date: string,
  fare: number,
  // ...
}
```

## 修正内容

### 1. `lib/hooks/useRealtimeSchedules.ts`の修正

`convertDbToSchedule`関数を新スキーマに対応：

```typescript
function convertDbToSchedule(dbRecord: any): Schedule {
    return {
        id: dbRecord.id,
        clientId: dbRecord.client_id || null,
        driverId: dbRecord.driver_id || null,
        vehicleId: dbRecord.vehicle_id || null,
        loadingDatetime: dbRecord.loading_datetime,
        loadingLocationId: dbRecord.loading_location_id || null,
        loadingLocationName: dbRecord.loading_location_name || null,
        loadingAddress: dbRecord.loading_address || null,
        deliveryDatetime: dbRecord.delivery_datetime,
        deliveryLocationId: dbRecord.delivery_location_id || null,
        deliveryLocationName: dbRecord.delivery_location_name || null,
        deliveryAddress: dbRecord.delivery_address || null,
        cargo: dbRecord.cargo || null,
        billingDate: dbRecord.billing_date || null,
        fare: dbRecord.fare || null,
        createdAt: dbRecord.created_at,
        updatedAt: dbRecord.updated_at,
    };
}
```

### 2. `app/schedules/SchedulesClient.tsx`の修正

範囲外警告の計算時に安全性チェックを追加：

```typescript
const scheduleDates = schedules
  .filter(s => s.loadingDatetime) // loadingDatetimeが存在するもののみ
  .map(s => new Date(s.loadingDatetime.split('T')[0]));
```

## テスト結果

修正後、以下の動作を確認：

✅ Aタブでスケジュールを作成 → Bタブに即座に反映  
✅ Aタブでスケジュールを更新 → Bタブに即座に反映  
✅ Aタブでスケジュールを削除 → Bタブから即座に削除  
✅ エラーが発生しない  
✅ カードが正常に表示される  

## 影響を受けるファイル

- `lib/hooks/useRealtimeSchedules.ts` - データ変換ロジック修正
- `app/schedules/SchedulesClient.tsx` - 安全性チェック追加
- `.kiro/specs/realtime-sync/tasks.md` - バグ修正を記録

## 今後の対策

1. スキーマ変更時は、リアルタイム同期の変換ロジックも必ず更新する
2. 型定義（`types/Schedule.ts`）とデータベーススキーマの整合性を定期的に確認
3. リアルタイム同期のテストケースを追加（Phase 6のタスク）

## 関連ドキュメント

- [スキーマ移行ガイド](../../../supabase/DATETIME_MIGRATION_GUIDE.md)
- [リアルタイム同期設計](./design.md)
- [リアルタイム同期タスク](./tasks.md)
